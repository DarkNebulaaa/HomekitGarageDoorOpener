<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wi-Fi è¨­å®š</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 500px at 50% -10%, rgba(37,99,235,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .wrap{
      width:100%;
      max-width:420px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    header{
      padding:18px 18px 12px 18px;
      border-bottom:1px solid var(--line);
    }
    .title{
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      margin:0 0 4px 0;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .content{ padding:16px 18px 18px 18px; }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      font-size:14px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .02s ease, border-color .15s ease, box-shadow .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background:linear-gradient(180deg, var(--primary), var(--primary2));
      border-color:transparent;
      color:#fff;
      box-shadow: 0 10px 18px rgba(37,99,235,.22);
    }
    .btn.primary:disabled{
      opacity:.55; cursor:not-allowed; box-shadow:none;
    }
    .btn.ghost{
      background:#fff;
    }
    .btn.small{
      padding:8px 10px;
      font-size:13px;
      border-radius:10px;
    }

    label{
      display:block;
      font-size:13px;
      font-weight:800;
      margin:14px 0 8px;
    }
    .field{
      position:relative;
    }
    input, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
      background:#fff;
      color:var(--text);
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .rightIcon{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .chip{
      font-size:12px;
      color:var(--muted);
      background:#f3f4f6;
      border:1px solid var(--line);
      padding:5px 8px;
      border-radius:999px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      max-height:260px;
      overflow-y:auto;
      background:#fff;
    }
    .net{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      cursor:pointer;
    }
    .net:last-child{ border-bottom:none; }
    .net:active{ background:#f9fafb; }
    .net .name{
      font-weight:800;
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:240px;
    }
    .net .meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-shrink:0;
    }
    .status{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      min-height:18px;
    }
    .status.err{ color: var(--danger); font-weight:700; }
    .footer{
      padding:12px 18px 16px;
      border-top:1px solid var(--line);
      background:linear-gradient(180deg, rgba(249,250,251,.75), rgba(255,255,255,.95));
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin:0 0 10px;
      line-height:1.4;
    }
    .btnbar{
      display:flex;
      gap:10px;
    }
    svg{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1 class="title">Wi-Fi è¨­å®š</h1>
        <p class="sub">é¸æ“‡ç¶²è·¯ã€è¼¸å…¥å¯†ç¢¼ï¼Œè®“è£ç½®é€£ä¸Šç¶²è·¯ã€‚</p>
      </header>

      <div class="content">
        <div class="row">
          <div class="chip" id="chipState">
            <!-- icon -->
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 18.5a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0-3Zm-6.6-5.1a10 10 0 0 1 13.2 0a1 1 0 1 0 1.3-1.5a12 12 0 0 0-15.8 0a1 1 0 1 0 1.3 1.5ZM2.7 9.7a15 15 0 0 1 18.6 0a1 1 0 0 0 1.2-1.6a17 17 0 0 0-21 0a1 1 0 1 0 1.2 1.6Zm5.4 7.5a6 6 0 0 1 7.8 0a1 1 0 0 0 1.3-1.5a8 8 0 0 0-10.4 0a1 1 0 0 0 1.3 1.5Z"/>
            </svg>
            <span id="stateText">å°šæœªé€£ç·š</span>
          </div>

          <button class="btn small ghost" id="btnScan" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M3 5h18v2H3V5Zm0 6h18v2H3v-2Zm0 6h18v2H3v-2Z"/>
            </svg>
            æƒæ
          </button>
        </div>

        <label for="ssidSelect">é¸æ“‡ Wi-Fiï¼ˆæƒæçµæœï¼‰</label>
        <select id="ssidSelect">
          <option value="" selected>â€” è«‹å…ˆæŒ‰ã€Œæƒæã€â€”</option>
        </select>

        <ul class="list" id="ssidList" style="display:none;"></ul>

        <label for="ssidInput">æˆ–æ‰‹å‹•è¼¸å…¥ SSID</label>
        <div class="field">
          <input id="ssidInput" type="text" placeholder="ä¾‹å¦‚ï¼šMyHomeWiFi" autocomplete="off" />
        </div>

        <label for="pwd">å¯†ç¢¼</label>
        <div class="field">
          <input id="pwd" type="password" placeholder="è‡³å°‘ 8 å€‹å­—å…ƒï¼ˆå¸¸è¦‹ï¼‰" autocomplete="current-password" />
          <div class="rightIcon">
            <button class="btn small ghost" id="togglePwd" type="button" aria-label="é¡¯ç¤º/éš±è—å¯†ç¢¼">é¡¯ç¤º</button>
          </div>
        </div>

        <div class="status" id="status"></div>
      </div>

      <div class="footer">
        <p class="hint">æç¤ºï¼šé¸æ“‡æƒæåˆ°çš„ Wi-Fi æœƒè‡ªå‹•å¸¶å…¥ SSIDï¼›ä¹Ÿå¯ç›´æ¥æ‰‹å‹•è¼¸å…¥ã€‚</p>
        <div class="btnbar">
          <button class="btn primary" id="btnSave" type="button" disabled>
            é€£ç·šä¸¦å„²å­˜
          </button>
          <button class="btn ghost" id="btnClear" type="button">
            æ¸…é™¤
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== ä½ éœ€è¦åœ¨ ESP32 ç«¯æä¾›å…©å€‹ APIï¼ˆå¯æ”¹è·¯å¾‘ï¼‰ ======
    // GET  /scan     -> å›å‚³ JSON é™£åˆ—ï¼Œä¾‹å¦‚:
    //   [{"ssid":"MyWiFi","rssi":-45,"sec":true},{"ssid":"Cafe","rssi":-70,"sec":false}]
    // POST /save     -> æ¥æ”¶ JSON: {"ssid":"...","password":"..."}
    //
    // å¦‚æœä½ æš«æ™‚æ²’æœ‰å¾Œç«¯ï¼Œä¸‹é¢æä¾› DEMO å‡è³‡æ–™æ¨¡å¼ã€‚

    const DEMO = false; // æ²’æ¥ä¸Š ESP32 API æ™‚å…ˆç”¨ trueï¼›æ¥ä¸Šå¾Œæ”¹ false

    const els = {
      btnScan: document.getElementById('btnScan'),
      btnSave: document.getElementById('btnSave'),
      btnClear: document.getElementById('btnClear'),
      togglePwd: document.getElementById('togglePwd'),
      ssidSelect: document.getElementById('ssidSelect'),
      ssidList: document.getElementById('ssidList'),
      ssidInput: document.getElementById('ssidInput'),
      pwd: document.getElementById('pwd'),
      status: document.getElementById('status'),
      stateText: document.getElementById('stateText'),
    };

    function setStatus(msg, isErr=false){
      els.status.textContent = msg || '';
      els.status.className = 'status' + (isErr ? ' err' : '');
    }

    function rssiBars(rssi){
      // ç²—ç•¥è½‰æ›ï¼šè¶Šæ¥è¿‘ 0 è¶Šå¼·
      if (rssi >= -55) return "â–®â–®â–®â–®";
      if (rssi >= -65) return "â–®â–®â–®";
      if (rssi >= -75) return "â–®â–®";
      return "â–®";
    }

    function secText(sec){
      return sec ? "ğŸ”’" : "ğŸ”“";
    }

    function updateSaveEnabled(){
      const ssid = (els.ssidInput.value || '').trim();
      const pwd  = els.pwd.value || '';
      // é–‹æ”¾å¼ç¶²è·¯å¯èƒ½ä¸éœ€è¦å¯†ç¢¼ï¼›ä½†ä¸€èˆ¬å¸¸è¦‹è‡³å°‘ 8
      // é€™è£¡åšã€Œæœ‰ SSID å°±èƒ½æŒ‰ã€ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆ (pwd.length>=8)
      els.btnSave.disabled = (ssid.length === 0);
    }

    function pickSSID(ssid){
      els.ssidInput.value = ssid || '';
      updateSaveEnabled();
    }

    function fillSelect(list){
      els.ssidSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'â€” é¸æ“‡ä¸€å€‹ç¶²è·¯ â€”';
      els.ssidSelect.appendChild(opt0);

      list.forEach(n=>{
        const o = document.createElement('option');
        o.value = n.ssid;
        o.textContent = `${n.ssid}  (${rssiBars(n.rssi)} ${n.rssi}dBm ${secText(n.sec)})`;
        els.ssidSelect.appendChild(o);
      });
    }

    function fillList(list){
      // çµ¦æ‰‹æ©Ÿç”¨ï¼šé»ä¸€ä¸‹å°±é¸
      els.ssidList.innerHTML = '';
      list.forEach(n=>{
        const li = document.createElement('li');
        li.className = 'net';
        li.innerHTML = `
          <div>
            <div class="name">${escapeHtml(n.ssid || '(hidden)')}</div>
            <div class="meta">${secText(n.sec)} <span>${n.rssi} dBm</span></div>
          </div>
          <div class="meta">${rssiBars(n.rssi)}</div>
        `;
        li.addEventListener('click', ()=> pickSSID(n.ssid));
        els.ssidList.appendChild(li);
      });
      els.ssidList.style.display = list.length ? 'block' : 'none';
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    async function apiScan(){
      if (DEMO){
        await new Promise(r=>setTimeout(r, 500));
        return [
          {ssid:"Mason-2.4G", rssi:-47, sec:true},
          {ssid:"Lab_AP", rssi:-61, sec:true},
          {ssid:"Cafe_Free_WiFi", rssi:-73, sec:false},
          {ssid:"Hidden", rssi:-82, sec:true},
        ];
      }
      const res = await fetch('/scan', {cache:'no-store'});
      if (!res.ok) throw new Error('scan failed');
      return await res.json();
    }

    async function apiSave(ssid, password){
      if (DEMO){
        await new Promise(r=>setTimeout(r, 700));
        return {ok:true};
      }
      const res = await fetch('/save', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ssid, password})
      });
      if (!res.ok) throw new Error('save failed');
      return await res.json();
    }

    // ====== events ======
    els.btnScan.addEventListener('click', async ()=>{
      setStatus('æ­£åœ¨æƒæ Wi-Fiâ€¦');
      els.btnScan.disabled = true;
      try{
        const list = await apiScan();
        // éæ¿¾ç©º SSIDï¼ˆæœ‰äº›æƒææœƒå› hidden SSIDï¼‰
        const cleaned = list
          .filter(n => n && typeof n.ssid === 'string' && n.ssid.length)
          .sort((a,b)=> (b.rssi ?? -999) - (a.rssi ?? -999));

        fillSelect(cleaned);
        fillList(cleaned);

        setStatus(cleaned.length ? `æ‰¾åˆ° ${cleaned.length} å€‹ç¶²è·¯ï¼Œé»é¸å³å¯å¸¶å…¥ SSIDã€‚` : 'æ²’æœ‰æƒæåˆ°ç¶²è·¯ï¼ˆæˆ–è¨Šè™Ÿå¤ªå¼±ï¼‰', !cleaned.length);
      }catch(e){
        setStatus('æƒæå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
      }finally{
        els.btnScan.disabled = false;
      }
    });

    els.ssidSelect.addEventListener('change', ()=>{
      const v = els.ssidSelect.value;
      if (v) pickSSID(v);
    });

    els.ssidInput.addEventListener('input', updateSaveEnabled);
    els.pwd.addEventListener('input', updateSaveEnabled);

    els.togglePwd.addEventListener('click', ()=>{
      const isPwd = els.pwd.type === 'password';
      els.pwd.type = isPwd ? 'text' : 'password';
      els.togglePwd.textContent = isPwd ? 'éš±è—' : 'é¡¯ç¤º';
    });

    els.btnClear.addEventListener('click', ()=>{
      els.ssidSelect.value = '';
      els.ssidInput.value = '';
      els.pwd.value = '';
      setStatus('');
      updateSaveEnabled();
    });

    els.btnSave.addEventListener('click', async ()=>{
      const ssid = (els.ssidInput.value || '').trim();
      const password = els.pwd.value || '';
      if (!ssid){
        setStatus('è«‹å…ˆé¸æ“‡æˆ–è¼¸å…¥ SSIDã€‚', true);
        return;
      }

      setStatus('æ­£åœ¨å„²å­˜ä¸¦å˜—è©¦é€£ç·šâ€¦');
      els.btnSave.disabled = true;

      try{
        const ret = await apiSave(ssid, password);
        // ret å¯ä»¥ç”±ä½ å¾Œç«¯å›å‚³æ›´å¤šè³‡è¨Šï¼Œä¾‹å¦‚ {ok:true, ip:"192.168.1.123"}
        setStatus('å·²é€å‡ºè¨­å®š âœ… è£ç½®å°‡å˜—è©¦é€£ç·šï¼Œè‹¥æˆåŠŸæœƒè‡ªå‹•é›¢é–‹æ­¤é ã€‚');
        els.stateText.textContent = 'å·²é€å‡ºè¨­å®š';
      }catch(e){
        setStatus('å„²å­˜å¤±æ•—ï¼Œè«‹ç¢ºèªå¯†ç¢¼æˆ–ç¨å¾Œå†è©¦ã€‚', true);
      }finally{
        updateSaveEnabled();
      }
    });

    // init
    updateSaveEnabled();
  </script>
</body>
</html>